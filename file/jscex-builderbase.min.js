(function () {
    var BuilderBase = function () {};

    BuilderBase.prototype = {

        Loop: function (condition, body, update, init) {
            return {
                next: function (ctx, callback) {

                    var executeBody = function (skipUpdate) {
                        update.next(ctx, function (type, value) {
                            if (type === "normal" || type === "continue") {
                                runLoop(skipUpdate);
                            } else if (type === "throw" || type === "return") {
                                callback(type, value);
                            } else if (type === "break") {
                                callback("normal");
                            } else {
                                throw new Error('Invalid type for "Loop": ' + type);
                            }
                        });
                    };

                    var runLoop = function (firstRun) {
                        try {
                            if (body && !firstRun) body.call(ctx);
                            if (!condition || condition.call(ctx)) {
                                executeBody(false);
                            } else {
                                callback("normal");
                            }
                        } catch (err) {
                            callback("throw", err);
                        }
                    };

                    init ? executeBody(true) : runLoop(true);
                }
            };
        },

        Delay: function (expr) {
            return {
                next: function (ctx, callback) {
                    try {
                        expr.call(ctx).next(ctx, callback);
                    } catch (err) {
                        callback("throw", err);
                    }
                }
            };
        },

        Combine: function (first, second) {
            return {
                next: function (ctx, callback) {
                    first.next(ctx, function (type, value, extra) {
                        if (type === "normal") {
                            try {
                                second.next(ctx, callback);
                            } catch (err) {
                                callback("throw", err);
                            }
                        } else {
                            callback(type, value, extra);
                        }
                    });
                }
            };
        },

        Return: function (value) {
            return {
                next: function (ctx, callback) {
                    callback("return", value);
                }
            };
        },

        Normal: function () {
            return {
                next: function (ctx, callback) {
                    callback("normal");
                }
            };
        },

        Break: function () {
            return {
                next: function (ctx, callback) {
                    callback("break");
                }
            };
        },

        Continue: function () {
            return {
                next: function (ctx, callback) {
                    callback("continue");
                }
            };
        },

        Throw: function (error) {
            return {
                next: function (ctx, callback) {
                    callback("throw", error);
                }
            };
        },

        Try: function (body, catchFn, finallyFn) {
            return {
                next: function (ctx, callback) {
                    body.next(ctx, function (type, value, extra) {

                        if (type !== "throw" || !catchFn) {
                            if (finallyFn) {
                                finallyFn.next(ctx, function (fType, fVal, fExtra) {
                                    fType === "normal"
                                        ? callback(type, value, extra)
                                        : callback(fType, fVal, fExtra);
                                });
                            } else {
                                callback(type, value, extra);
                            }
                        } else {
                            var handled;
                            try {
                                handled = catchFn.call(ctx, value);
                            } catch (err) {
                                if (finallyFn) {
                                    finallyFn.next(ctx, function (fType, fVal, fExtra) {
                                        fType === "normal"
                                            ? callback("throw", err)
                                            : callback(fType, fVal, fExtra);
                                    });
                                } else {
                                    callback("throw", err);
                                }
                                return;
                            }

                            handled && handled.next(ctx, function (hType, hVal, hExtra) {
                                if (finallyFn) {
                                    finallyFn.next(ctx, function (fType, fVal, fExtra) {
                                        fType === "normal"
                                            ? callback(hType, hVal, hExtra)
                                            : callback(fType, fVal, fExtra);
                                    });
                                } else {
                                    callback(hType, hVal, hExtra);
                                }
                            });
                        }
                    });
                }
            };
        }
    };

    var init = function (root) {
        if (!root.modules) root.modules = {};
        if (!root.modules.builderbase) {
            root.modules.builderbase = true;
            root.BuilderBase = BuilderBase;
        }
    };

    var isCmd = typeof define === "function" && !define.amd;
    var isAmd = typeof require === "function" && typeof define === "function" && define.amd;

    if (typeof require === "function" && typeof module !== "undefined" && module.exports) {
        module.exports.init = init;
    } else if (isCmd) {
        define("jscex-builderbase", function (require, exports, module) {
            module.exports.init = init;
        });
    } else if (isAmd) {
        define("jscex-builderbase", function () {
            return { init: init };
        });
    } else {
        if (typeof Jscex === "undefined") {
            throw new Error('Missing the root object, please load "jscex" module first.');
        }
        init(Jscex);
    }

})();
